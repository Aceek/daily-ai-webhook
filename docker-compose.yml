services:
  n8n:
    image: n8nio/n8n:2.0.3
    container_name: ai-news-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # Authentication
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      # Timezone
      - GENERIC_TIMEZONE=Europe/Paris
      - TZ=Europe/Paris
      # Allow access to env vars in expressions
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      # Discord webhook (accessible via $env.DISCORD_WEBHOOK_URL)
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
    volumes:
      # Persistent n8n data
      - ./n8n-data:/home/node/.n8n
    depends_on:
      claude-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  claude-service:
    build: ./claude-service
    container_name: ai-news-claude
    restart: unless-stopped
    environment:
      - CLAUDE_MODEL=${CLAUDE_MODEL:-sonnet}
      - CLAUDE_TIMEOUT=${CLAUDE_TIMEOUT:-600}
      - CLAUDE_RETRY_COUNT=${CLAUDE_RETRY_COUNT:-1}
      - CLAUDE_LOG_LEVEL=${CLAUDE_LOG_LEVEL:-info}
    volumes:
      # Named volume for Claude CLI runtime data (statsig, todos, projects, etc.)
      # Keeps runtime files in Docker, not synced to host
      - claude-runtime:/root/.claude
      # Our config files mounted read-only (copied to /root/.claude by entrypoint)
      - ./claude-config/CLAUDE.md:/app/claude-config/CLAUDE.md:ro
      - ./claude-config/agents:/app/claude-config/agents:ro
      - ./claude-config/docs:/app/claude-config/docs:ro
      - ./claude-config/.credentials.json:/app/claude-config/.credentials.json:ro
      - ./claude-config/.mcp.json:/app/claude-config/.mcp.json:ro
      # MCP config directly in /app for Claude CLI discovery (project scope)
      - ./claude-config/.mcp.json:/app/.mcp.json:ro
      # MCP server code (mounted read-only)
      - ./mcp-server:/app/mcp-server:ro
      # Execution logs (includes research/ and digests/ subdirectories)
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Expose port for debugging
    ports:
      - "8080:8080"

volumes:
  claude-runtime:
    name: ai-news-claude-runtime
